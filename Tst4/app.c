#include "stm32f4xx.h"  // Подключите соответствующий заголовочный файл

void GPIO_Config(void) {
    // Включаем тактирование GPIOA
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN;

    // Настраиваем пины PA5, PA6, PA7 в альтернативную функцию
    GPIOA->MODER &= ~(3 << (5 * 2));  // Очистка режима для PA5
    GPIOA->MODER |= (2 << (5 * 2));   // Альтернативная функция для PA5

    GPIOA->MODER &= ~(3 << (6 * 2));  // Очистка режима для PA6
    GPIOA->MODER |= (2 << (6 * 2));   // Альтернативная функция для PA6

    GPIOA->MODER &= ~(3 << (7 * 2));  // Очистка режима для PA7
    GPIOA->MODER |= (2 << (7 * 2));   // Альтернативная функция для PA7

    // Настраиваем альтернативные функции (AF5 для SPI1)
    GPIOA->AFR[0] |= (5 << (5 * 4)) | (5 << (6 * 4)) | (5 << (7 * 4)); // AF5 для SPI1
}

void SPI_Config(void) {
    // Включаем тактирование SPI1
    RCC->APB2ENR |= RCC_APB2ENR_SPI1EN;

    // Сбрасываем настройки SPI
    SPI1->CR1 = 0;

    // Настраиваем параметры SPI: мастер, частота делителя, режим
    SPI1->CR1 |= SPI_CR1_MSTR        // Режим мастера
               | (3 << SPI_CR1_BR_Pos) // Частота делителя (SPI_CLK / 16, можно настроить по необходимости)
               | SPI_CR1_CPOL          // Полярность (0: первый фронт по восходящей)
               | SPI_CR1_CPHA          // Фаза (0: данные считаются на третьем фронте)
               | SPI_CR1_SSI           // Включение внутреннего уровня
               | SPI_CR1_SSM;          // Установка SS в программном режиме

    // Включаем SPI
    SPI1->CR1 |= SPI_CR1_SPE;
}

uint8_t SPI_TransmitReceive(uint8_t data) {
    // Ждем, пока не будет готов приемник
    while (!(SPI1->SR & SPI_SR_TXE)); // Ждем, пока не станет готов передатчик

    // Отправляем данные
    SPI1->DR = data;

    // Ждем, пока не будет готов приемник
    while (!(SPI1->SR & SPI_SR_RXNE)); // Ждем, пока не пришли данные

    // Читаем данные
    return SPI1->DR; // Возвращаем полученные данные
}

int main(void) {
    GPIO_Config(); // Настройка GPIO
    SPI_Config();  // Настройка SPI

    while (1)
			{
				for(int i=0; i<100000;i++)
				{
				};
        uint8_t txData = 0xA5; // Пример передаваемых данных
        uint8_t rxData = SPI_TransmitReceive(txData); // Передача и прием данных

        // Обработка полученных данных (rxData) по необходимости
    }
}